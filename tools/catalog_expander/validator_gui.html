<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikiflix Validator Pro ğŸš€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        iframe { width: 100%; aspect-ratio: 16/9; background: #000; display: block; border-radius: 0.75rem; margin: 0; }
        select { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        /* Scrollbar Custom */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        /* Animazioni */
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-red { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-slate-900 border-b border-slate-700 p-3 flex justify-between items-center z-20 shadow-md">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-purple-400">
                Wikiflix <span class="text-white font-light">Validator Pro</span>
            </h1>
            <input type="file" id="fileInput" accept=".jsonl" class="text-xs text-slate-400 file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-slate-700 file:text-white hover:file:bg-slate-600 cursor-pointer">
        </div>
        <div class="flex items-center gap-6">
            <div class="flex flex-col items-end">
                <div class="text-xs text-slate-400">Progresso Sessione</div>
                <div class="font-mono font-bold text-sky-400" id="progressText">0 / 0</div>
            </div>
            <button onclick="clearProgress()" class="text-xs text-red-400 hover:text-red-300 underline mr-4">
                ğŸ—‘ï¸ Reset Memoria
            </button>
            <button onclick="exportQuickStatements()" id="btnExport" disabled class="bg-purple-600 hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white px-4 py-2 rounded shadow font-bold transition flex items-center gap-2">
                ğŸ’¾ Export QS Batch
            </button>
        </div>
    </header>

    <main class="flex-1 flex p-4 gap-4 overflow-hidden relative" id="mainArea">
        
        <div id="welcomeScreen" class="absolute inset-0 flex flex-col items-center justify-center z-0 text-slate-600">
            <svg class="w-32 h-32 mb-4 opacity-20" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
            <p class="text-xl">Carica il file <code class="text-sky-500">.jsonl</code> per iniziare</p>
        </div>

        <div class="w-1/3 flex flex-col gap-4 hidden z-10" id="leftPanel">
            <div class="card rounded-xl p-6 h-full flex flex-col relative overflow-hidden shadow-lg">
                <div class="absolute top-0 right-0 p-6 opacity-5 font-bold text-9xl text-white select-none pointer-events-none">WD</div>
                
                <div class="mb-6">
                    <span class="bg-sky-900 text-sky-200 text-xs font-bold px-2 py-1 rounded border border-sky-700">TARGET ITEM</span>
                    <h2 class="text-3xl font-bold text-white mt-2 leading-tight" id="wdTitle">Titolo Film</h2>
                    <a id="wdLink" href="#" target="_blank" class="text-sky-400 hover:text-sky-300 text-sm font-mono mt-1 inline-block">Qxxxxxx â†—</a>
                </div>

                <div class="grid grid-cols-2 gap-y-6 gap-x-4 text-sm">
                    <div>
                        <div class="text-slate-500 font-bold uppercase text-[10px]">Anno Previsto</div>
                        <div class="text-xl text-white font-medium" id="wdYear">----</div>
                    </div>
                    <div>
                        <div class="text-slate-500 font-bold uppercase text-[10px]">Durata Target</div>
                        <div class="text-xl text-white font-medium" id="wdDuration">--:--</div>
                    </div>
                    <div class="col-span-2">
                        <div class="text-slate-500 font-bold uppercase text-[10px]">Titolo Originale</div>
                        <div class="text-slate-300 italic" id="wdOrig">...</div>
                    </div>
                </div>

                <div class="mt-auto space-y-2" id="alertArea">
                    </div>
            </div>
        </div>

        <div class="w-2/3 flex flex-col gap-4 hidden z-10" id="rightPanel">
            
            <div class="card rounded-xl overflow-hidden shadow-lg bg-black flex flex-col">
                <div id="playerContainer" class="w-full"></div>
                
                <div class="p-4 bg-slate-800 border-t border-slate-700 flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-white line-clamp-1" id="ytTitle">YouTube Title</h3>
                        <div class="flex items-center gap-3 text-sm text-slate-400 mt-1">
                            <span class="flex items-center gap-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> <span id="ytChannel">Channel</span></span>
                            <span>â€¢</span>
                            <span id="ytDate">YYYY-MM-DD</span>
                            <span>â€¢</span>
                            <span id="ytDuration" class="font-mono text-white">00:00</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-bold" id="matchScore">0.00</div>
                        <div class="text-[10px] text-slate-500 uppercase tracking-wider">Score</div>
                    </div>
                </div>
            </div>

            <div class="card rounded-xl p-4 flex gap-4 items-center h-24 shadow-lg">
                
                <div class="flex-1">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Lingua / Didascalie (P407)</label>
                    <div class="flex gap-2">
                        <select id="langSelect" class="bg-slate-900 border border-slate-600 text-white text-sm rounded block w-full p-2.5 focus:ring-sky-500 focus:border-sky-500">
                            <option value="">-- Seleziona --</option>
                            <option value="Q652">ğŸ‡®ğŸ‡¹ Italiano (Q652)</option>
                            <option value="Q1860">ğŸ‡¬ğŸ‡§ Inglese (Q1860)</option>
                            <option value="Q150">ğŸ‡«ğŸ‡· Francese (Q150)</option>
                            <option value="Q188">ğŸ‡©ğŸ‡ª Tedesco (Q188)</option>
                            <option value="Q1321">ğŸ‡ªğŸ‡¸ Spagnolo (Q1321)</option>
                            <option value="Q7737">ğŸ‡·ğŸ‡º Russo (Q7737)</option>
                            <option value="Q5146">ğŸ‡µğŸ‡¹ Portoghese (Q5146)</option>
                            <option value="Q5287">ğŸ‡¯ğŸ‡µ Giapponese (Q5287)</option>
                            <option value="Q9240">ğŸ‡®ğŸ‡© Indonesiano (Q9240)</option>
                            <option value="Q9027">ğŸ‡¸ğŸ‡ª Svedese (Q9027)</option>
                            <option value="Q256">ğŸ‡¹ğŸ‡· Turco (Q256)</option>
                            <option value="Q9129">ğŸ‡¬ğŸ‡· Greco Moderno (Q9129)</option>
                            <option value="Q6654">ğŸ‡­ğŸ‡· Croato (Q6654)</option>
                            <option value="Q20923490">ğŸŒ Multilingue (Q20923490)</option>
                            <option value="Q21027227">ğŸ”‡ Muto / No Lingua</option>
                        </select>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="discardCurrent()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg font-bold transition border border-slate-600 flex flex-col items-center justify-center min-w-[100px]" title="Scorciatoia: Freccia SX">
                        <span>SCARTA</span>
                        <span class="text-[10px] font-normal opacity-50">[â†]</span>
                    </button>
                    <button onclick="approveCurrent()" class="px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-bold transition shadow-lg shadow-green-900/50 flex flex-col items-center justify-center min-w-[120px]" title="Scorciatoia: Freccia DX">
                        <span>APPROVA</span>
                        <span class="text-[10px] font-normal opacity-50">[â†’]</span>
                    </button>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- CONFIG ---
        // Mappa codici lingua Scraper -> QID Wikidata
        const LANG_MAP = {
            'it': 'Q652', 'en': 'Q1860', 'fr': 'Q150', 'de': 'Q188', 
            'es': 'Q1321', 'ru': 'Q7737', 'pt': 'Q5146', 'ja': 'Q5287', 'id': 'Q9240', 'sv': 'Q9027', 'tr': 'Q256', 'el': 'Q9129', 'mul': 'Q20923490', 'hr': 'Q6654'
        };

        let movies = [];
        let approved = [];
        let currentIndex = 0;
        let duplicateCheckCache = new Map(); // Cache per non fare spam di chiamate

        const dom = {
            welcome: document.getElementById('welcomeScreen'),
            left: document.getElementById('leftPanel'),
            right: document.getElementById('rightPanel'),
            progress: document.getElementById('progressText'),
            btnExport: document.getElementById('btnExport'),
            
            wdTitle: document.getElementById('wdTitle'),
            wdLink: document.getElementById('wdLink'),
            wdYear: document.getElementById('wdYear'),
            wdDur: document.getElementById('wdDuration'),
            wdOrig: document.getElementById('wdOrig'),
            alertArea: document.getElementById('alertArea'),

            player: document.getElementById('playerContainer'),
            ytTitle: document.getElementById('ytTitle'),
            ytChannel: document.getElementById('ytChannel'),
            ytDate: document.getElementById('ytDate'),
            ytDur: document.getElementById('ytDuration'),
            score: document.getElementById('matchScore'),
            
            langSelect: document.getElementById('langSelect')
        };

        // --- AUTO-SAVE LOGIC ---
        const STORAGE_KEY = 'wikiflix_progress_backup';

        function saveProgress() {
            const state = {
                approved: approved,
                currentIndex: currentIndex,
                // Salviamo anche l'array movies cosÃ¬ se ricarichi non devi riselezionare il file
                // (Attenzione: se il file Ã¨ enorme > 5MB potrebbe non starci, ma proviamo)
                // Se Ã¨ troppo pesante, salviamo solo gli ID e ricaricherai il file a mano.
            };
            // Salviamo solo la lista degli approvati e l'indice per sicurezza/velocitÃ 
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                approved: approved,
                currentIndex: currentIndex
            }));
            
            // Feedback visivo discreto
            dom.btnExport.innerText = `ğŸ’¾ Export QS Batch (${approved.length}) - Saved âœ“`;
        }

        function loadProgress() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                approved = data.approved || [];
                // Non sovrascriviamo currentIndex subito, aspettiamo il caricamento del file
                console.log("Backup trovato! Approvati:", approved.length);
                return data;
            }
            return null;
        }

        function clearProgress() {
            if(confirm("Sei sicuro? Questo cancellerÃ  la memoria del validatore.")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // 1. CARICAMENTO
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                movies = ev.target.result.split('\n')
                    .filter(l => l.trim())
                    .map(l => { try { return JSON.parse(l); } catch { return null; }})
                    .filter(x => x);
                
                start();
            };
            reader.readAsText(file);
        });

        function start() {
            dom.welcome.classList.add('hidden');
            dom.left.classList.remove('hidden');
            dom.right.classList.remove('hidden');
            
            // >>> AGGIUNTA: CARICAMENTO BACKUP <<<
            const backup = loadProgress();
            if (backup && backup.approved.length > 0) {
                // Recuperiamo gli approvati
                approved = backup.approved;
                
                // Opzione A: Riprendi esattamente da dove eri
                // currentIndex = backup.currentIndex;

                // Opzione B (PiÃ¹ sicura): Ricalcola l'indice basandosi sugli ID giÃ  fatti
                // Saltiamo i film nel file JSONL che abbiamo giÃ  approvato
                // const approvedIds = new Set(approved.map(a => a.qid)); // Assumendo 1 video per film, altrimenti usa logica diversa
                
                // Se vuoi riprendere esattamente dall'indice salvato:
                if (backup.currentIndex > 0 && backup.currentIndex < movies.length) {
                    currentIndex = backup.currentIndex + 1;
                    alert(`Bentornato! Ho recuperato ${approved.length} video approvati. Riprendiamo dal n. ${currentIndex + 1}.`);
                }
            } else {
                currentIndex = 0;
            }

            updateStats(); // Aggiorna il bottone con il numero recuperato
            render();
        }

        // 2. RENDER PRINCIPALE
        async function render() {
            if (currentIndex >= movies.length) {
                alert("Validazione Finita! Esporta i dati.");
                return;
            }

            const m = movies[currentIndex];
            dom.progress.innerText = `${currentIndex + 1} / ${movies.length}`;

            // WD Data
            dom.wdTitle.innerText = m.original_title;
            dom.wdLink.innerText = m.qid;
            dom.wdLink.href = `https://www.wikidata.org/wiki/${m.qid}`;
            dom.wdYear.innerText = m.target_year || "---";
            dom.wdDur.innerText = fmtDur(m.found_duration);
            dom.wdOrig.innerText = m.original_title;

            // YT Data
            dom.ytTitle.innerText = m.found_title;
            dom.ytChannel.innerText = m.found_channel_name;
            dom.ytDate.innerText = m.found_upload_date;
            dom.ytDur.innerText = fmtDur(m.found_duration);
            
            // Score Visuals
            const s = parseFloat(m.score || m.match_score || 0);
            dom.score.innerText = s.toFixed(2);
            dom.score.className = `text-2xl font-bold ${s > 0.8 ? 'text-green-400' : (s > 0.6 ? 'text-yellow-400' : 'text-red-400')}`;

            // Player
            dom.player.innerHTML = `<iframe src="https://www.youtube-nocookie.com/embed/${m.found_id}?rel=0&controls=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;

            // --- AUTO SELECT LANGUAGE ---
            let preselect = "";
            // Se lo scraper ha trovato 'it' nei sub automatici, suggerisci Italiano
            if (m.auto_subs && m.auto_subs.includes('it')) preselect = "Q652";
            // Fallback sulla lingua di ricerca
            else if (m.search_lang && LANG_MAP[m.search_lang]) preselect = LANG_MAP[m.search_lang];
            
            dom.langSelect.value = preselect;

            // --- LIVE WIKIDATA CHECK ---
            checkWikidataExistence(m.found_id);
        }

        // 3. SPARQL CHECK
        async function checkWikidataExistence(ytId) {
            dom.alertArea.innerHTML = '<div class="text-xs text-slate-500 animate-pulse">Checking Wikidata...</div>';
            
            if (duplicateCheckCache.has(ytId)) {
                showExistenceAlert(duplicateCheckCache.get(ytId));
                return;
            }

            const query = `SELECT ?item ?itemLabel WHERE { ?item wdt:P1651 "${ytId}". SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". } }`;
            const url = `https://query.wikidata.org/sparql?query=${encodeURIComponent(query)}&format=json`;

            try {
                const resp = await fetch(url);
                const data = await resp.json();
                const exists = data.results.bindings.length > 0;
                
                duplicateCheckCache.set(ytId, exists ? data.results.bindings[0] : null);
                showExistenceAlert(exists ? data.results.bindings[0] : null);
            } catch (e) {
                dom.alertArea.innerHTML = '<div class="text-xs text-red-500">SPARQL Error</div>';
            }
        }

        function showExistenceAlert(item) {
            const currentQid = movies[currentIndex] ? movies[currentIndex].qid : '';

            if (item) {
                // Caso: Video GIÃ€ PRESENTE su Wikidata
                const qid = item.item.value.split('/').pop();
                const label = item.itemLabel ? item.itemLabel.value : qid;
                
                dom.alertArea.innerHTML = `
                    <div class="bg-red-900/40 border border-red-500/50 text-red-100 p-4 rounded-lg flex flex-col gap-3 shadow-inner">
                        <div class="flex items-start gap-3">
                            <div class="text-2xl animate-pulse-red">âš ï¸</div>
                            <div>
                                <strong class="text-red-400 uppercase text-[10px] tracking-wider">Conflitto Rilevato</strong>
                                <div class="text-sm font-bold leading-tight mt-1">
                                    Video giÃ  usato su: <br>
                                    <span class="text-white">${label}</span>
                                </div>
                            </div>
                        </div>

                        <a href="${item.item.value}" target="_blank" 
                           class="group bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 px-3 rounded flex items-center justify-center gap-2 transition-all border border-red-400">
                            <span>ğŸ“</span>
                            <span>Gestisci ${qid} su WD</span>
                            <span class="group-hover:translate-x-1 transition-transform">â†’</span>
                        </a>
                    </div>
                `;
            } else {
                // Caso: Video NUOVO (Via libera)
                dom.alertArea.innerHTML = `
                    <div class="flex flex-col gap-2">
                        <div class="bg-green-900/30 border border-green-600/50 text-green-400 p-3 rounded text-xs text-center font-bold shadow-sm">
                            âœ¨ VIDEO NUOVO
                        </div>
                        
                        <a href="https://www.wikidata.org/wiki/${currentQid}" target="_blank" 
                           class="text-[10px] text-slate-500 hover:text-sky-400 text-center flex items-center justify-center gap-1 transition-colors">
                           <span>ğŸ”§ Modifica manuale Item corrente (${currentQid})</span>
                        </a>
                    </div>
                `;
            }
        }

        // 4. ACTIONS
        function approveCurrent() {
            const m = movies[currentIndex];
            const selectedLang = dom.langSelect.value;
            
            const approvedItem = { ...m, selected_language: selectedLang };
            approved.push(approvedItem);
            
            // >>> AGGIUNTA: SALVA ADESSO <<<
            saveProgress();
            
            updateStats();
            currentIndex++;
            render();
        }

        function discardCurrent() {
            currentIndex++;
            render();
        }

        function updateStats() {
            dom.btnExport.disabled = approved.length === 0;
            dom.btnExport.innerHTML = `ğŸ’¾ Export QS Batch (${approved.length})`;
        }

        function fmtDur(sec) {
            if (!sec) return "--:--";
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}m ${s}s`;
        }

        // 5. EXPORT PER QUICKSTATEMENTS
        function exportQuickStatements() {
            if (approved.length === 0) return;

            const lines = approved.map(m => {
                // QID | P1651 | "ID_VIDEO"
                let line = `${m.qid}|P1651|"${m.found_id}"`;
                
                // Qualificatori standard
                line += `|P1810|"${m.found_title.replace(/"/g, '\\"')}"`; // P1810 Title
                if (m.found_duration) line += `|P2047|${m.found_duration}U2150204`; // P2047 Duration
                if (m.found_channel_id) line += `|P2397|"${m.found_channel_id}"`; // P2397 Channel
                if (m.found_upload_date) line += `|P577|+${m.found_upload_date}T00:00:00Z/11`; // P577 Date
                
                // P407 (Lingua) - SOLO SE SELEZIONATA
                if (m.selected_language) {
                    line += `|P407|${m.selected_language}`;
                }

                // P585 (Data Validazione)
                const today = new Date().toISOString().split('T')[0];
                line += `|P585|+${today}T00:00:00Z/11`;

                return line;
            });

            const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wikiflix_QS_${new Date().getTime()}.txt`;
            a.click();
        }

        // SHORTCUTS
        document.addEventListener('keydown', (e) => {
            if (dom.welcome.classList.contains('hidden')) {
                if (e.key === 'ArrowRight') approveCurrent();
                if (e.key === 'ArrowLeft') discardCurrent();
            }
        });
    </script>
</body>
</html>